"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ping = exports.pingUri = void 0;
const bigint_buffer_1 = require("bigint-buffer");
const dns_1 = require("dns");
const net_1 = require("net");
const url = __importStar(require("url"));
const varint_1 = require("varint");
const PacketDecoder_1 = require("./PacketDecoder");
const PROTOCOL_VERSION = 335; // Minecraft 1.12
/**
 * ping with URI
 * @param uri minecraft://server[:port]
 */
exports.pingUri = async (uri) => {
    const { protocol, hostname, port } = url.parse(uri);
    if (!hostname || !protocol || protocol !== 'minecraft:') {
        throw new TypeError('not correct minecraft URI');
    }
    return exports.ping(hostname, port ? parseInt(port, 10) : undefined);
};
/**
 * ping with hostname and port
 * @param hostname hostname
 * @param port port number (defaults 25565)
 */
exports.ping = async (hostname = 'localhost', port = 25565) => {
    let address = { hostname, port };
    try {
        address = await checkSrvRecord(address.hostname);
    }
    catch (err) {
        // ignore
    }
    return openConnection(address);
};
const checkSrvRecord = (hostname) => {
    return new Promise((resolve, reject) => {
        if (net_1.isIP(hostname) !== 0) {
            reject(new Error('Hostname is an IP address'));
        }
        else {
            dns_1.resolveSrv('_minecraft._tcp.' + hostname, (error, result) => {
                if (error) {
                    reject(error);
                }
                else {
                    if (!resolve[0]) {
                        reject(new Error('dns: no srv found with name'));
                    }
                    resolve({
                        hostname: result[0].name,
                        port: result[0].port,
                    });
                }
            });
        }
    });
};
const openConnection = (address) => {
    let timeout;
    return new Promise((resolve, reject) => {
        const socket = net_1.createConnection(address.port, address.hostname, async () => {
            const packetDecoder = new PacketDecoder_1.PacketDecoder();
            socket.pipe(packetDecoder);
            packetDecoder.once('error', (error) => {
                socket.destroy();
                if (timeout) {
                    clearTimeout(timeout);
                }
                reject(error);
            });
            // handshake
            socket.write(createHandshakePacket(address));
            const handshakeData = await packetDecoder.oncePromise('handshake');
            // ping
            socket.write(createPingPacket(BigInt(Date.now())));
            const pingData = await packetDecoder.oncePromise('pong');
            if (timeout) {
                clearTimeout(timeout);
            }
            socket.end();
            resolve({
                ...handshakeData,
                ping: pingData,
            });
        });
        // Destroy on error
        socket.once('error', (error) => {
            socket.destroy();
            if (timeout) {
                clearTimeout(timeout);
            }
            reject(error);
        });
        // Destroy on timeout
        socket.once('timeout', () => {
            socket.destroy();
            if (timeout) {
                clearTimeout(timeout);
            }
            reject(new Error('Timed out'));
        });
        // Packet timeout (10 seconds)
        timeout = setTimeout(() => {
            socket.end();
            reject(new Error('Timed out (10 seconds passed)'));
        }, 10000);
    });
};
const createHandshakePacket = (address) => {
    const portBuffer = Buffer.allocUnsafe(2);
    portBuffer.writeUInt16BE(address.port, 0);
    // Return hansdhake packet with request packet
    return Buffer.concat([
        createPacket(0, Buffer.concat([
            Buffer.from(varint_1.encode(PROTOCOL_VERSION)),
            Buffer.from(varint_1.encode(address.hostname.length)),
            Buffer.from(address.hostname, 'utf8'),
            portBuffer,
            Buffer.from(varint_1.encode(1)),
        ])),
        createPacket(0, Buffer.alloc(0)),
    ]);
};
const createPingPacket = (timestamp) => {
    return createPacket(1, bigint_buffer_1.toBufferBE(timestamp, 8));
};
const createPacket = (packetId, data) => {
    return Buffer.concat([Buffer.from(varint_1.encode(varint_1.encodingLength(packetId) + data.length)), Buffer.from(varint_1.encode(packetId)), data]);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi9zcmMvIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsaURBQXlDO0FBQ3pDLDZCQUErQjtBQUMvQiw2QkFBMkM7QUFDM0MseUNBQTJCO0FBQzNCLG1DQUE4QztBQUU5QyxtREFBOEM7QUFFOUMsTUFBTSxnQkFBZ0IsR0FBRyxHQUFHLENBQUMsQ0FBQyxpQkFBaUI7QUFFL0M7OztHQUdHO0FBQ1UsUUFBQSxPQUFPLEdBQUcsS0FBSyxFQUFFLEdBQVcsRUFBRSxFQUFFO0lBQzVDLE1BQU0sRUFBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBQyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDbEQsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLFFBQVEsSUFBSSxRQUFRLEtBQUssWUFBWSxFQUFFO1FBQ3hELE1BQU0sSUFBSSxTQUFTLENBQUMsMkJBQTJCLENBQUMsQ0FBQztLQUNqRDtJQUNELE9BQU8sWUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQzlELENBQUMsQ0FBQztBQUVGOzs7O0dBSUc7QUFDVSxRQUFBLElBQUksR0FBRyxLQUFLLEVBQUUsV0FBbUIsV0FBVyxFQUFFLE9BQWUsS0FBSyxFQUEyQixFQUFFO0lBQzNHLElBQUksT0FBTyxHQUFhLEVBQUMsUUFBUSxFQUFFLElBQUksRUFBQyxDQUFDO0lBQ3pDLElBQUk7UUFDSCxPQUFPLEdBQUcsTUFBTSxjQUFjLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBQ2pEO0lBQUMsT0FBTyxHQUFHLEVBQUU7UUFDYixTQUFTO0tBQ1Q7SUFDRCxPQUFPLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNo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QUMsQ0FBQyxDQUFDO1NBQ3RCLENBQUMsQ0FDRjtRQUNELFlBQVksQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNoQyxDQUFDLENBQUM7QUFDSixDQUFDLENBQUM7QUFFRixNQUFNLGdCQUFnQixHQUFHLENBQUMsU0FBaUIsRUFBRSxFQUFFO0lBQzlDLE9BQU8sWUFBWSxDQUFDLENBQUMsRUFBRSwwQkFBVSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2xELENBQUMsQ0FBQztBQUVGLE1BQU0sWUFBWSxHQUFHLENBQUMsUUFBZ0IsRUFBRSxJQUFZLEVBQVUsRUFBRTtJQUMvRCxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGVBQU0sQ0FBQyx1QkFBYyxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsZUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUMxSCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge3RvQnVmZmVyQkV9IGZyb20gJ2JpZ2ludC1idWZmZXInO1xuaW1wb3J0IHtyZXNvbHZlU3J2fSBmcm9tICdkbnMnO1xuaW1wb3J0IHtjcmVhdGVDb25uZWN0aW9uLCBpc0lQfSBmcm9tICduZXQnO1xuaW1wb3J0ICogYXMgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQge2VuY29kZSwgZW5jb2RpbmdMZW5ndGh9IGZyb20gJ3ZhcmludCc7XG5pbXBvcnQge0lBZGRyZXNzLCBJSGFuZHNoYWtlRGF0YSwgSU1pbmVjcmFmdERhdGF9IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5pbXBvcnQge1BhY2tldERlY29kZXJ9IGZyb20gJy4vUGFja2V0RGVjb2Rlcic7XG5cbmNvbnN0IFBST1RPQ09MX1ZFUlNJT04gPSAzMzU7IC8vIE1pbmVjcmFmdCAxLjEyXG5cbi8qKlxuICogcGluZyB3aXRoIFVSSVxuICogQHBhcmFtIHVyaSBtaW5lY3JhZnQ6Ly9zZXJ2ZXJbOnBvcnRdXG4gKi9cbmV4cG9ydCBjb25zdCBwaW5nVXJpID0gYXN5bmMgKHVyaTogc3RyaW5nKSA9PiB7XG5cdGNvbnN0IHtwcm90b2NvbCwgaG9zdG5hbWUsIHBvcnR9ID0gdXJsLnBhcnNlKHVyaSk7XG5cdGlmICghaG9zdG5hbWUgfHwgIXByb3RvY29sIHx8IHByb3RvY29sICE9PSAnbWluZWNyYWZ0OicpIHtcblx0XHR0aHJvdyBuZXcgVHlwZUVycm9yKCdub3QgY29ycmVjdCBtaW5lY3JhZnQgVVJJJyk7XG5cdH1cblx0cmV0dXJuIHBpbmcoaG9zdG5hbWUsIHBvcnQgPyBwYXJzZUludChwb3J0LCAxMCkgOiB1bmRlZmluZWQpO1xufTtcblxuLyoqXG4gKiBwaW5nIHdpdGggaG9zdG5hbWUgYW5kIHBvcnRcbiAqIEBwYXJhbSBob3N0bmFtZSBob3N0bmFtZVxuICogQHBhcmFtIHBvcnQgcG9ydCBudW1iZXIgKGRlZmF1bHRzIDI1NTY1KVxuICovXG5leHBvcnQgY29uc3QgcGluZyA9IGFzeW5jIChob3N0bmFtZTogc3RyaW5nID0gJ2xvY2FsaG9zdCcsIHBvcnQ6IG51bWJlciA9IDI1NTY1KTogUHJvbWlzZTxJTWluZWNyYWZ0RGF0YT4gPT4ge1xuXHRsZXQgYWRkcmVzczogSUFkZHJlc3MgPSB7aG9zdG5hbWUsIHBvcnR9O1xuXHR0cnkge1xuXHRcdGFkZHJlc3MgPSBhd2FpdCBjaGVja1NydlJlY29yZChhZGRyZXNzLmhvc3RuYW1lKTtcblx0fSBjYXRjaCAoZXJyKSB7XG5cdFx0Ly8gaWdub3JlXG5cdH1cblx0cmV0dXJuIG9wZW5Db25uZWN0aW9uKGFkZHJlc3MpO1xufTtcblxuY29uc3QgY2hlY2tTcnZSZWNvcmQgPSAoaG9zdG5hbWU6IHN0cmluZyk6IFByb21pc2U8SUFkZHJlc3M+ID0+IHtcblx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRpZiAoaXNJUChob3N0bmFtZSkgIT09IDApIHtcblx0XHRcdHJlamVjdChuZXcgRXJyb3IoJ0hvc3RuYW1lIGlzIGFuIElQIGFkZHJlc3MnKSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHJlc29sdmVTcnYoJ19taW5lY3JhZnQuX3RjcC4nICsgaG9zdG5hbWUsIChlcnJvciwgcmVzdWx0KSA9PiB7XG5cdFx0XHRcdGlmIChlcnJvcikge1xuXHRcdFx0XHRcdHJlamVjdChlcnJvcik7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0aWYgKCFyZXNvbHZlWzBdKSB7XG5cdFx0XHRcdFx0XHRyZWplY3QobmV3IEVycm9yKCdkbnM6IG5vIHNydiBmb3VuZCB3aXRoIG5hbWUnKSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdHJlc29sdmUoe1xuXHRcdFx0XHRcdFx0aG9zdG5hbWU6IHJlc3VsdFswXS5uYW1lLFxuXHRcdFx0XHRcdFx0cG9ydDogcmVzdWx0WzBdLnBvcnQsXG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXHRcdH1cblx0fSk7XG59O1xuXG5jb25zdCBvcGVuQ29ubmVjdGlvbiA9IChhZGRyZXNzOiBJQWRkcmVzcyk6IFByb21pc2U8SU1pbmVjcmFmdERhdGE+ID0+IHtcblx0bGV0IHRpbWVvdXQ6IFJldHVyblR5cGU8dHlwZW9mIHNldFRpbWVvdXQ+IHwgdW5kZWZpbmVkO1xuXHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdGNvbnN0IHNvY2tldCA9IGNyZWF0ZUNvbm5lY3Rpb24oYWRkcmVzcy5wb3J0LCBhZGRyZXNzLmhvc3RuYW1lLCBhc3luYyAoKSA9PiB7XG5cdFx0XHRjb25zdCBwYWNrZXREZWNvZGVyID0gbmV3IFBhY2tldERlY29kZXIoKTtcblx0XHRcdHNvY2tldC5waXBlKHBhY2tldERlY29kZXIpO1xuXHRcdFx0cGFja2V0RGVjb2Rlci5vbmNlKCdlcnJvcicsIChlcnJvcikgPT4ge1xuXHRcdFx0XHRzb2NrZXQuZGVzdHJveSgpO1xuXHRcdFx0XHRpZiAodGltZW91dCkge1xuXHRcdFx0XHRcdGNsZWFyVGltZW91dCh0aW1lb3V0KTtcblx0XHRcdFx0fVxuXHRcdFx0XHRyZWplY3QoZXJyb3IpO1xuXHRcdFx0fSk7XG5cdFx0XHQvLyBoYW5kc2hha2Vcblx0XHRcdHNvY2tldC53cml0ZShjcmVhdGVIYW5kc2hha2VQYWNrZXQoYWRkcmVzcykpO1xuXHRcdFx0Y29uc3QgaGFuZHNoYWtlRGF0YSA9IGF3YWl0IHBhY2tldERlY29kZXIub25jZVByb21pc2U8SUhhbmRzaGFrZURhdGE+KCdoYW5kc2hha2UnKTtcblx0XHRcdC8vIHBpbmdcblx0XHRcdHNvY2tldC53cml0ZShjcmVhdGVQaW5nUGFja2V0KEJpZ0ludChEYXRlLm5vdygpKSkpO1xuXHRcdFx0Y29uc3QgcGluZ0RhdGEgPSBhd2FpdCBwYWNrZXREZWNvZGVyLm9uY2VQcm9taXNlPG51bWJlcj4oJ3BvbmcnKTtcblx0XHRcdGlmICh0aW1lb3V0KSB7XG5cdFx0XHRcdGNsZWFyVGltZW91dCh0aW1lb3V0KTtcblx0XHRcdH1cblx0XHRcdHNvY2tldC5lbmQoKTtcblxuXHRcdFx0cmVzb2x2ZSh7XG5cdFx0XHRcdC4uLmhhbmRzaGFrZURhdGEsXG5cdFx0XHRcdHBpbmc6IHBpbmdEYXRhLFxuXHRcdFx0fSk7XG5cdFx0fSk7XG5cdFx0Ly8gRGVzdHJveSBvbiBlcnJvclxuXHRcdHNvY2tldC5vbmNlKCdlcnJvcicsIChlcnJvcikgPT4ge1xuXHRcdFx0c29ja2V0LmRlc3Ryb3koKTtcblx0XHRcdGlmICh0aW1lb3V0KSB7XG5cdFx0XHRcdGNsZWFyVGltZW91dCh0aW1lb3V0KTtcblx0XHRcdH1cblx0XHRcdHJlamVjdChlcnJvcik7XG5cdFx0fSk7XG5cblx0XHQvLyBEZXN0cm95IG9uIHRpbWVvdXRcblx0XHRzb2NrZXQub25jZSgndGltZW91dCcsICgpID0+IHtcblx0XHRcdHNvY2tldC5kZXN0cm95KCk7XG5cdFx0XHRpZiAodGltZW91dCkge1xuXHRcdFx0XHRjbGVhclRpbWVvdXQodGltZW91dCk7XG5cdFx0XHR9XG5cdFx0XHRyZWplY3QobmV3IEVycm9yKCdUaW1lZCBvdXQnKSk7XG5cdFx0fSk7XG5cblx0XHQvLyBQYWNrZXQgdGltZW91dCAoMTAgc2Vjb25kcylcblx0XHR0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG5cdFx0XHRzb2NrZXQuZW5kKCk7XG5cdFx0XHRyZWplY3QobmV3IEVycm9yKCdUaW1lZCBvdXQgKDEwIHNlY29uZHMgcGFzc2VkKScpKTtcblx0XHR9LCAxMDAwMCk7XG5cdH0pO1xufTtcblxuY29uc3QgY3JlYXRlSGFuZHNoYWtlUGFja2V0ID0gKGFkZHJlc3M6IElBZGRyZXNzKTogQnVmZmVyID0+IHtcblx0Y29uc3QgcG9ydEJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSgyKTtcblx0cG9ydEJ1ZmZlci53cml0ZVVJbnQxNkJFKGFkZHJlc3MucG9ydCwgMCk7XG5cdC8vIFJldHVybiBoYW5zZGhha2UgcGFja2V0IHdpdGggcmVxdWVzdCBwYWNrZXRcblx0cmV0dXJuIEJ1ZmZlci5jb25jYXQoW1xuXHRcdGNyZWF0ZVBhY2tldChcblx0XHRcdDAsXG5cdFx0XHRCdWZmZXIuY29uY2F0KFtcblx0XHRcdFx0QnVmZmVyLmZyb20oZW5jb2RlKFBST1RPQ09MX1ZFUlNJT04pKSxcblx0XHRcdFx0QnVmZmVyLmZyb20oZW5jb2RlKGFkZHJlc3MuaG9zdG5hbWUubGVuZ3RoKSksXG5cdFx0XHRcdEJ1ZmZlci5mcm9tKGFkZHJlc3MuaG9zdG5hbWUsICd1dGY4JyksXG5cdFx0XHRcdHBvcnRCdWZmZXIsXG5cdFx0XHRcdEJ1ZmZlci5mcm9tKGVuY29kZSgxKSksXG5cdFx0XHRdKSxcblx0XHQpLFxuXHRcdGNyZWF0ZVBhY2tldCgwLCBCdWZmZXIuYWxsb2MoMCkpLFxuXHRdKTtcbn07XG5cbmNvbnN0IGNyZWF0ZVBpbmdQYWNrZXQgPSAodGltZXN0YW1wOiBiaWdpbnQpID0+IHtcblx0cmV0dXJuIGNyZWF0ZVBhY2tldCgxLCB0b0J1ZmZlckJFKHRpbWVzdGFtcCwgOCkpO1xufTtcblxuY29uc3QgY3JlYXRlUGFja2V0ID0gKHBhY2tldElkOiBudW1iZXIsIGRhdGE6IEJ1ZmZlcik6IEJ1ZmZlciA9PiB7XG5cdHJldHVybiBCdWZmZXIuY29uY2F0KFtCdWZmZXIuZnJvbShlbmNvZGUoZW5jb2RpbmdMZW5ndGgocGFja2V0SWQpICsgZGF0YS5sZW5ndGgpKSwgQnVmZmVyLmZyb20oZW5jb2RlKHBhY2tldElkKSksIGRhdGFdKTtcbn07XG4iXX0=